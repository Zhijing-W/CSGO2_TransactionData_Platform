{% extends "base.html" %}

{% block title %}Add New Transaction{% endblock %}

{% block extra_css %}
<style>
    /* Hacker Style Transaction Form */
    .page-title {
        font-family: 'JetBrains Mono', monospace;
        font-size: 2.5rem;
        margin: 0 0 2rem 0;
        background: linear-gradient(135deg, var(--neon-pink) 0%, var(--neon-yellow) 25%, var(--neon-orange) 50%, var(--neon-pink) 75%, var(--neon-purple) 100%);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradientShift 3s ease infinite;
        letter-spacing: 3px;
        text-transform: uppercase;
        font-weight: 900;
    }

    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    .tab-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--hacker-green);
    }
    
    .tab-link {
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        border-bottom: none;
        color: var(--text-muted);
        padding: 1rem 2rem;
        cursor: pointer;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        position: relative;
        font-family: 'JetBrains Mono', monospace;
    }

    .tab-link::before {
        content: '>';
        position: absolute;
        left: 0.5rem;
        opacity: 0;
        color: var(--hacker-green);
        transition: all 0.3s ease;
    }
    
    .tab-link:hover {
        color: var(--hacker-green);
        background: var(--bg-tertiary);
        border-color: var(--hacker-green);
        padding-left: 2.5rem;
    }

    .tab-link:hover::before {
        opacity: 1;
    }
    
    .tab-link.active {
        color: var(--hacker-green);
        background: linear-gradient(135deg, var(--neon-pink) 0%, var(--neon-purple) 100%);
        border-color: var(--hacker-green);
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        box-shadow: 0 0 30px rgba(131, 56, 236, 0.4);
    }
    
    .tab-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--hacker-green);
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.8);
    }
    
    .tab-content {
        display: none;
        background: var(--bg-secondary);
        border: 2px solid var(--hacker-green);
        border-radius: 8px;
        padding: 2rem;
        margin-top: 0;
        box-shadow: 0 0 40px rgba(0, 255, 65, 0.2),
                    inset 0 0 20px rgba(0, 255, 65, 0.05);
        position: relative;
        overflow: hidden;
    }

    .tab-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.1), transparent);
        animation: scan 3s infinite;
    }

    @keyframes scan {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .tab-content.active {
        display: block;
    }
    
    fieldset {
        border: 2px solid var(--hacker-green);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        background: var(--bg-tertiary);
        position: relative;
        z-index: 1;
    }
    
    legend {
        color: var(--hacker-green);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.9rem;
        padding: 0 1rem;
        font-family: 'JetBrains Mono', monospace;
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    
    .holdings-selector {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: var(--bg-tertiary);
        border: 2px solid var(--hacker-green);
        border-left: 4px solid var(--hacker-green);
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        position: relative;
        z-index: 1;
    }
    
    .holdings-selector strong {
        color: var(--hacker-green);
        font-family: 'JetBrains Mono', monospace;
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    
    .holdings-selector p {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin: 0.5rem 0;
        font-family: 'JetBrains Mono', monospace;
    }
    
    .holdings-selector select {
        width: 100%;
        padding: 0.75rem;
        margin-top: 0.5rem;
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        transition: all 0.3s ease;
    }

    .holdings-selector select:focus {
        outline: none;
        border-color: var(--hacker-green);
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
    }
    
    .holdings-selector button {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, var(--neon-pink) 0%, var(--neon-purple) 100%);
        border: 2px solid var(--hacker-green);
        color: var(--hacker-green);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'JetBrains Mono', monospace;
        box-shadow: 0 0 30px rgba(131, 56, 236, 0.4);
        position: relative;
        overflow: hidden;
    }

    .holdings-selector button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(0, 255, 65, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    
    .holdings-selector button:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 50px rgba(131, 56, 236, 0.6),
                    0 0 30px rgba(0, 255, 65, 0.4);
        border-color: var(--neon-pink);
    }

    .holdings-selector button:hover::before {
        width: 300px;
        height: 300px;
    }
    
    label {
        display: block;
        color: var(--hacker-green);
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 2px;
        font-family: 'JetBrains Mono', monospace;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select {
        width: 100%;
        padding: 1rem;
        background: var(--bg-tertiary);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        border-radius: 4px;
        transition: all 0.3s ease;
        font-size: 1rem;
    }
    
    input:focus,
    select:focus {
        outline: none;
        border-color: var(--hacker-green);
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.4),
                    inset 0 0 10px rgba(0, 255, 65, 0.1);
        background: var(--bg-secondary);
    }
    
    small {
        display: block;
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-top: 0.25rem;
        font-style: italic;
        font-family: 'JetBrains Mono', monospace;
    }
    
    button[type="submit"] {
        background: linear-gradient(135deg, var(--neon-pink) 0%, var(--neon-purple) 100%);
        border: 2px solid var(--hacker-green);
        color: var(--hacker-green);
        padding: 1rem 2rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.1rem;
        margin-top: 1.5rem;
        box-shadow: 0 0 30px rgba(131, 56, 236, 0.4);
        position: relative;
        overflow: hidden;
        width: 100%;
    }

    button[type="submit"]::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(0, 255, 65, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    
    button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 50px rgba(131, 56, 236, 0.6),
                    0 0 30px rgba(0, 255, 65, 0.4);
        border-color: var(--neon-pink);
    }

    button[type="submit"]:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .form-section {
        margin: 1.5rem 0;
    }
</style>
{% endblock %}

{% block content %}

<h1 class="page-title">âš¡ ADD TRANSACTION</h1>
<p style="color: var(--text-muted); margin-bottom: 2rem; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 1px;">> Add a purchase or sale record to your account ({{ current_user.display_name }})</p>

<div class="tab-container">
    <button class="tab-link active" onclick="openTab(event, 'purchase')">[ PURCHASE ]</button>
    <button class="tab-link" onclick="openTab(event, 'sale')">[ SALE ]</button>
</div>

<!-- Purchase Form -->
<div id="purchase" class="tab-content active">
    <h2 class="csgo-section-title" style="margin-top: 0;">> RECORD PURCHASE</h2>
    <form action="{{ url_for('purchase_create') }}" method="POST" id="purchaseForm">
        <fieldset>
            <legend>ITEM DETAILS</legend>
            <p style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 1rem;">If the item doesn't exist, a new one will be created in the database.</p>
            <div class="form-section">
                <label for="p_market_name">Market Name:</label>
                <input type="text" id="p_market_name" name="market_name" placeholder="e.g., AWP | Asiimov" required>
            </div>
            <div class="form-section">
                <label for="p_exterior">Exterior (Wear):</label>
                <select id="p_exterior" name="exterior" required>
                    <option value="">-- Select Wear --</option>
                    <option value="Factory New">Factory New</option>
                    <option value="Minimal Wear">Minimal Wear</option>
                    <option value="Field-Tested">Field-Tested</option>
                    <option value="Well-Worn">Well-Worn</option>
                    <option value="Battle-Scarred">Battle-Scarred</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>TRANSACTION DETAILS</legend>
            <div class="form-section">
                <label for="p_platform_id">Platform:</label>
                <select id="p_platform_id" name="platform_id" required>
                    <option value="">-- Select Platform --</option>
                    {% for platform in platforms %}
                        <option value="{{ platform.platform_id }}">{{ platform.platform_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-section">
                <label for="p_price">Price:</label>
                <input type="number" step="0.01" id="p_price" name="price" placeholder="e.g., 220.50 or 200" required>
                <small>(Enter 200 and it will be saved as 200.00)</small>
            </div>
            <div class="form-section">
                <label for="p_currency">Currency:</label>
                <select id="p_currency" name="currency" required>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CNY">CNY</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>
            <div class="form-section">
                <label for="p_ts">Date of Purchase:</label>
                <input type="datetime-local" id="p_ts" name="ts" required>
            </div>
        </fieldset>
        <div>
            <button type="submit">[ SUBMIT PURCHASE ]</button>
        </div>
    </form>
</div>

<!-- Sale Form -->
<div id="sale" class="tab-content">
    <h2 class="csgo-section-title" style="margin-top: 0;">> RECORD SALE</h2>
    
    {% if holdings %}
    <div class="holdings-selector">
        <strong>ðŸ“¦ QUICK IMPORT FROM HOLDINGS:</strong>
        <p>Select an item from your holdings to auto-fill the form:</p>
        <select id="holdingsSelect" onchange="importFromHoldings()">
            <option value="">-- Select from Holdings --</option>
            {% for holding in holdings %}
                <option value="{{ holding.item_id }}" 
                        data-name="{{ holding.market_name }}" 
                        data-exterior="{{ holding.exterior }}"
                        data-quantity="{{ holding.quantity_held }}">
                    {{ holding.market_name }} ({{ holding.exterior }}) - Qty: {{ holding.quantity_held }}
                </option>
            {% endfor %}
        </select>
        <button type="button" onclick="importFromHoldings()">[ IMPORT ]</button>
    </div>
    {% else %}
    <div class="holdings-selector">
        <p style="color: var(--text-muted);">You don't have any items in your holdings yet. Add a purchase first to enable quick import.</p>
    </div>
    {% endif %}
    
    {% if prefill_market_name %}
    <div class="holdings-selector" style="border-left-color: var(--hacker-green);">
        <strong style="color: var(--hacker-green);">> PRE-FILLED FROM HOLDINGS</strong>
        <p>Item: {{ prefill_market_name }} ({{ prefill_exterior }})</p>
    </div>
    {% endif %}
    
    <form action="{{ url_for('sale_create') }}" method="POST" id="saleForm">
        <fieldset>
            <legend>ITEM DETAILS</legend>
            <p style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 1rem;">You can only sell items that you have purchased and are in your holdings.</p>
            <div class="form-section">
                <label for="s_market_name">Market Name:</label>
                <input type="text" id="s_market_name" name="market_name" value="{{ prefill_market_name or '' }}" placeholder="e.g., AWP | Asiimov" required>
            </div>
            <div class="form-section">
                <label for="s_exterior">Exterior (Wear):</label>
                <select id="s_exterior" name="exterior" required>
                    <option value="">-- Select Wear --</option>
                    <option value="Factory New" {% if prefill_exterior == 'Factory New' %}selected{% endif %}>Factory New</option>
                    <option value="Minimal Wear" {% if prefill_exterior == 'Minimal Wear' %}selected{% endif %}>Minimal Wear</option>
                    <option value="Field-Tested" {% if prefill_exterior == 'Field-Tested' %}selected{% endif %}>Field-Tested</option>
                    <option value="Well-Worn" {% if prefill_exterior == 'Well-Worn' %}selected{% endif %}>Well-Worn</option>
                    <option value="Battle-Scarred" {% if prefill_exterior == 'Battle-Scarred' %}selected{% endif %}>Battle-Scarred</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>TRANSACTION DETAILS</legend>
            <div class="form-section">
                <label for="s_platform_id">Platform:</label>
                <select id="s_platform_id" name="platform_id" required>
                    <option value="">-- Select Platform --</option>
                    {% for platform in platforms %}
                        <option value="{{ platform.platform_id }}">{{ platform.platform_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-section">
                <label for="s_price">Sale Price:</label>
                <input type="number" step="0.01" id="s_price" name="price" placeholder="e.g., 250.00 or 250" required>
                <small>(Enter 250 and it will be saved as 250.00)</small>
            </div>
            <div class="form-section">
                <label for="s_fee">Sale Fee (if any):</label>
                <input type="number" step="0.01" id="s_fee" name="fee" placeholder="e.g., 12.50 or 12" value="0" required>
                <small>(Enter 12 and it will be saved as 12.00)</small>
            </div>
            <div class="form-section">
                <label for="s_currency">Currency:</label>
                <select id="s_currency" name="currency" required>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CNY">CNY</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>
            <div class="form-section">
                <label for="s_ts">Date of Sale:</label>
                <input type="datetime-local" id="s_ts" name="ts" required>
            </div>
        </fieldset>
        <div>
            <button type="submit">[ SUBMIT SALE ]</button>
        </div>
    </form>
</div>

<script>
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function importFromHoldings() {
    var select = document.getElementById('holdingsSelect');
    var selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        document.getElementById('s_market_name').value = selectedOption.getAttribute('data-name');
        document.getElementById('s_exterior').value = selectedOption.getAttribute('data-exterior');
    }
}

// Auto-format prices to 2 decimal places on blur
function formatPrice(input) {
    if (input.value && input.value.trim() !== '') {
        var value = parseFloat(input.value);
        if (!isNaN(value)) {
            input.value = value.toFixed(2);
        }
    }
}

// Add event listeners for price inputs
document.addEventListener('DOMContentLoaded', function() {
    var priceInputs = ['p_price', 's_price', 's_fee'];
    priceInputs.forEach(function(id) {
        var input = document.getElementById(id);
        if (input) {
            input.addEventListener('blur', function() {
                formatPrice(this);
            });
        }
    });
    
    // Format prices on form submit
    var purchaseForm = document.getElementById('purchaseForm');
    if (purchaseForm) {
        purchaseForm.addEventListener('submit', function(e) {
            var priceInput = document.getElementById('p_price');
            if (priceInput && priceInput.value) {
                formatPrice(priceInput);
            }
        });
    }
    
    var saleForm = document.getElementById('saleForm');
    if (saleForm) {
        saleForm.addEventListener('submit', function(e) {
            var priceInput = document.getElementById('s_price');
            var feeInput = document.getElementById('s_fee');
            if (priceInput && priceInput.value) {
                formatPrice(priceInput);
            }
            if (feeInput && feeInput.value) {
                formatPrice(feeInput);
            }
        });
    }
    
    // Auto-open sale tab if action=sell
    {% if action == 'sell' %}
    document.querySelector('.tab-link[onclick*="sale"]').click();
    {% endif %}
});
</script>

{% endblock %}
