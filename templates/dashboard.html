{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <h1>Project Dashboard</h1>
    
    <h2>Portfolio Dashboard (Req #4)</h2>
    <p>Aggregated portfolio value, PnL, and ROI for all users.</p>
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Total Investment</th>
                <th>Current Market Value</th>
                <th>Realized PnL</th>
                <th>Unrealized PnL</th>
                <th>Total PnL</th>
                <th>ROI</th>
            </tr>
        </thead>
        <tbody>
            {% for row in portfolios %}
            <tr>
                <td>{{ row.display_name }}</td>
                <td>{{ "%.2f"|format(row.total_investment) }}</td>
                <td>{{ "%.2f"|format(row.total_market_value) }}</td>
                
                {% if row.total_realized_pnl > 0 %}
                    <td style="color: green;">+{{ "%.2f"|format(row.total_realized_pnl) }}</td>
                {% else %}
                    <td style="color: red;">{{ "%.2f"|format(row.total_realized_pnl) }}</td>
                {% endif %}

                {% if row.total_unrealized_pnl > 0 %}
                    <td style="color: green;">+{{ "%.2f"|format(row.total_unrealized_pnl) }}</td>
                {% else %}
                    <td style="color: red;">{{ "%.2f"|format(row.total_unrealized_pnl) }}</td>
                {% endif %}

                {% if row.total_pnl > 0 %}
                    <td style="color: green; font-weight: bold;">+{{ "%.2f"|format(row.total_pnl) }}</td>
                {% else %}
                    <td style="color: red; font-weight: bold;">{{ "%.2f"|format(row.total_pnl) }}</td>
                {% endif %}
                
                {% if row.roi_percent > 0 %}
                    <td style="color: green; font-weight: bold;">{{ "%.2f"|format(row.roi_percent) }}%</td>
                {% else %}
                    <td style="color: red; font-weight: bold;">{{ "%.2f"|format(row.roi_percent) }}%</td>
                {% endif %}
            </tr>
            {% else %}
            <tr><td colspan="7">No portfolio data found.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Recent Transactions (Last 60 Days)</h2>
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Item</th>
                <th>Platform</th>
                <th>Side</th>
                <th>Date</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            {% for row in transactions %}
            <tr>
                <td>{{ row.display_name }}</td>
                <td>{{ row.market_name }}</td>
                <td>{{ row.platform_name }}</td>
                <td>{{ row.side }}</td>
                <td>{{ row.ts.strftime('%Y-%m-%d') }}</td>
                <td>{{ "%.2f"|format(row.price) }}</td>
            </tr>
            {% else %}
            <tr><td colspan="6">No recent transactions found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    
    <h2>Platform Sales Overview (Last 7 Days)</h2>
    <table>
        <thead>
            <tr>
                <th>Platform Name</th>
                <th>Total Sales</th>
                <th>Avg. Sale Price</th>
            </tr>
        </thead>
        <tbody>
            {% for row in platforms %}
            <tr>
                <td>{{ row.platform_name }}</td>
                <td>{{ row.n_sales }}</td>
                <td>{{ "%.2f"|format(row.avg_sale_price) }}</td>
            </tr>
            {% else %}
            <tr><td colspan="3">No platform sales data found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
