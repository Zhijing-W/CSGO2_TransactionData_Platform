{% extends "base.html" %}

{% block title %}Details for {{ item.get('market_name', 'Item') }}{% endblock %}

{% block content %}
    <p><a href="{{ url_for('items_list') }}">&larr; Back to All Items</a></p>

    <h1>{{ item.get('market_name', 'Item Details') }}</h1>
    
    <div style="background-color: #eee; padding: 1em; margin-bottom: 2em;">
        <p><strong>Item ID:</strong> {{ item_id }}</p>
        <p><strong>Game:</strong> {{ item.get('game', 'N/A') }}</p>
        <p><strong>Rarity:</strong> {{ item.get('rarity', 'N/A') }}</p>
        <p><strong>Exterior:</strong> {{ item.get('exterior', 'N/A') }}</p>
        <p><strong>Extra:</strong> {{ item.get('extra', 'None') }}</p>
    </div>

    <h2>Price History</h2>
    <div style="width: 100%; margin: auto;">
        <canvas id="priceChart"></canvas>
    </div>

    <h2>Purchase History</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>User</th>
                <th>Platform</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td>{{ purchase.ts.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ purchase.display_name }}</td>
                <td>{{ purchase.platform_name }}</td>
                <td>{{ "%.2f"|format(purchase.price) }} {{ purchase.currency }}</td>
                <td>
                    {% if purchase.display_name == current_user.display_name %}
                        <a href="{{ url_for('purchase_edit_form', purchase_id=purchase.purchase_id) }}" style="margin-right: 10px;">Edit</a>
                        <form action="{{ url_for('purchase_delete', purchase_id=purchase.purchase_id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this purchase? This action cannot be undone.');">
                            <button type="submit" style="background: none; border: none; color: red; cursor: pointer; padding: 0;">Delete</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="5">No purchase records found for this item.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Sales History</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>User</th>
                <th>Platform</th>
                <th>Price</th>
                <th>Fee</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales %}
            <tr>
                <td>{{ sale.ts.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ sale.display_name }}</td>
                <td>{{ sale.platform_name }}</td>
                <td>{{ "%.2f"|format(sale.price) }} {{ sale.currency }}</td>
                <td>{{ "%.2f"|format(sale.fee) }} {{ sale.currency }}</td>
                <td>
                    {% if sale.display_name == current_user.display_name %}
                        <a href="{{ url_for('sale_edit_form', sale_id=sale.sale_id) }}" style="margin-right: 10px;">Edit</a>
                        <form action="{{ url_for('sale_delete', sale_id=sale.sale_id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this sale? This action cannot be undone.');">
                            <button type="submit" style="background: none; border: none; color: red; cursor: pointer; padding: 0;">Delete</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6">No sales records found for this item.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Market Snapshots</h2>
    <table>
        <thead>
            <tr>
                <th>Captured At</th>
                <th>Platform</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            {% for snap in snapshots %}
            <tr>
                <td>{{ snap.captured_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ snap.platform_name }}</td>
                <td>{{ "%.2f"|format(snap.price) }} {{ snap.currency }}</td>
            </tr>
            {% else %}
            <tr><td colspan="3">No market snapshots found for this item.</td></tr>
            {% endfor %}
        </tbody>
    </table>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const snapshots = {{ snapshots|tojson }};

        if (snapshots && snapshots.length > 0) {
            const chartLabels = snapshots.map(s => {
                // The date string from `tojson` might need to be parsed
                let date = new Date(s.captured_at);
                return date.toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });
            });
            const chartData = snapshots.map(s => s.price);

            const ctx = document.getElementById('priceChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Price (USD)',
                        data: chartData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Price History (USD)'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            },
                            beginAtZero: false // Better for seeing small price fluctuations
                        }
                    }
                }
            });
        } else {
            // Optional: If you want to hide the canvas or show a message if no data
            const chartCanvas = document.getElementById('priceChart');
            if(chartCanvas) {
                const parentDiv = chartCanvas.parentElement;
                parentDiv.innerHTML = '<p>No price history data available to display a chart.</p>';
            }
        }
    });
</script>
{% endblock %}
