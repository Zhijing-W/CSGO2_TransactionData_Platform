# COMS W4111 Project: CS2 Portfolio Tracker

  * **Author:** Zhijing Wu (Philip), Drew Hu
  * **UNI:** `zw3155`, `yh3913`

## 1\. Live Application & Database Info

### Live Application URL

This application has been deployed on our Google Cloud VM and is running 24/7 in a `screen` session for grading.

**URL: [http://34.138.218.13:8111]**

### PostgreSQL Account (for Grading)

The PostgreSQL account used for this project is:

  * **UNI:** `zw3155`
  * **Host:** `34.139.8.30`
  * **Database:** `proj1part2`

## 2\. Demo Account (Recommended)

To demonstrate the application's full capabilities (including the Portfolio Dashboard), you can log in with the following pre-populated demo account:

  * **Email:** `zw3155@columbia.edu`
  * **Password:** `123456789`

This account has been pre-populated with sample `Purchase` and `Sale` data to make the `Dashboard` and `Holdings` pages functional for demonstration.

## 3\. How to Run (VM Deployment)

If the server needs to be restarted, the process is as follows:

1.  SSH into the Google Cloud VM.
2.  Activate the Python virtual environment: `source ./.virtualenvs/dbproj/bin/activate`
3.  Navigate to the project directory: `cd CSGO2_TransactionData_Platform`
4.  Pull the latest code from the `main` branch: `git pull`
5.  Run the server (using `screen` to keep it alive):
    ```bash
    screen python3 server.py
    ```
6.  Detach from the `screen` session by pressing `CTRL + A`, then `D`.

## 4\. Implemented Features

This application successfully implements all core features specified in our Part 1 Proposal, built as a secure, multi-user platform where each user's data is private.

  * **Full User Authentication:** Users can `/register` a new account (with password hashing via `werkzeug`) and `/login` (managed by `flask-login` sessions).
  * **User-Private Data:** All financial pages (`/dashboard`, `/holdings`) are protected by `@login_required` and all SQL queries are strictly filtered by `current_user.id`, ensuring users can only see their own data.
  * **Add Purchase (Get-or-Create):** The `/purchases/new` form allows a logged-in user to add a new purchase. This triggers a "Get-or-Create" transaction in the backend.
  * **Item Price History:** The `/items` catalog page allows users to click any item to see its detailed `/item/<id>` page, which shows global price history from the `Purchases`, `Sales`, and `MarketSnapshots` tables.
  * **Personal Holdings Page (Req \#2):** The `/holdings` page shows a detailed, item-by-item breakdown of the user's current holdings, calculating `Average Buy Cost`, `Current Market Price`, and `Unrealized PnL` for each.
  * **Portfolio Dashboard (Req \#4):** The `/dashboard` page serves as the user's homepage, showing an aggregated summary of their entire portfolio, including `Total Investment`, `Total Market Value`, `Realized PnL`, `Unrealized PnL`, and `ROI %`.

## 5\. Two Most Interesting Database Operations

As required by the Part 3 `README` guidelines, these are the two web pages that we believe involve the most interesting database operations:

### 1\. Add New Purchase (Route: `POST /purchases/create`)

  * **Purpose:** This is the backend logic for the "Add Purchase" form. It allows a user to log a new purchase and ensures that the item exists in the master `Items` catalog.
  * **Database Operation:** This function is interesting because it performs a "Get-or-Create" logic inside a single, safe **transaction** (`with engine.begin():`).
    1.  A `SELECT` query first checks if an item with a matching `market_name` and `exterior` already exists.
    2.  **If it does not exist**, a second query (`SELECT COALESCE(MAX(item_id), 0) + 1...`) safely finds the next available `item_id`.
    3.  A third query (`INSERT INTO Items...`) creates the new item in the catalog.
    4.  A fourth query (`SELECT COALESCE(MAX(purchase_id), 0) + 1...`) finds the next `purchase_id`.
    5.  A final `INSERT INTO Purchases...` query logs the transaction, linking the `user_id` and the (newly found or created) `item_id`.
  * **Why it's interesting:** This demonstrates a complex, multi-step write process that must be **atomic**. By wrapping all 5 queries in a single transaction, we ensure that if any step fails (e.g., the `INSERT INTO Purchases` fails), the entire operation is **rolled back**, preventing "orphan" items from being created.

### 2\. Portfolio Dashboard (Route: `GET /dashboard`)

  * **Purpose:** This page provides the logged-in user with a high-level summary of their entire investment portfolio, including their overall profit/loss and return on investment (ROI).
  * **Database Operation:** This page is generated by a single, complex SQL query that is over 70 lines long. This query uses **six** Common Table Expressions (CTEs) to build the final report, all filtered by `current_user.id`:
    1.  `latest_market_price`: Uses `DISTINCT ON` to find the single most recent price for every item.
    2.  `purchase_summary`: Aggregates all of a user's purchases by item to find `qty_bought`, `total_cost_basis_item`, and `avg_buy_cost`.
    3.  `sales_summary`: Aggregates all sales to find `qty_sold` and `total_sale_revenue_item`.
    4.  `holdings`: Joins the purchase and sale summaries to calculate the current `quantity_held` for each item.
    5.  `portfolio_calcs`: Uses a `FULL OUTER JOIN` to combine all previous CTEs, calculating `realized_pnl` (from sales) and `unrealized_pnl` (from current holdings) for every item the user has ever touched.
    6.  **Final `SELECT`:** The main query then aggregates all calculations from `portfolio_calcs` into a single row for the user, calculating final `total_pnl` and `roi_percent` (using a `CASE` statement to prevent division-by-zero errors).
  * **Why it's interesting:** This single query demonstrates mastery of advanced SQL concepts to build a complex financial report. It uses `WITH` clauses for modularity, `DISTINCT ON` for price-finding, `FULL OUTER JOIN` to correctly combine purchase/sale histories, and `CASE` statements for safe division.

## 6\. Future Work
While this project successfully fulfills the Part 1 proposal, we have identified several areas for future enhancement:

3. Implement "Add Sale" Form: Add a form for users to log Sale transactions, which would complete the portfolio loop and allow Realized PnL to be calculated based on user sales (rather than just purchases).

4. Multi-Currency Support: Integrate a real-time FX (Foreign Exchange) rate API. This would allow users to record purchases in different currencies (EUR, CNY, etc.) and see their portfolio value displayed in a single, user-selected currency (e.g., USD).

5. Homepage Dashboard: Integrate external market APIs (e.g., Steam, CSFloat) to display a public-facing dashboard of the current top-selling items.

6. Real-Time Valuation: Fetch live prices for all items in a user's portfolio to calculate an immediate "total liquidation value" (profit if all items were sold instantly).

7. UI/UX Enhancement: Implement data visualization (e.g., using Chart.js) to display PnL trends and holding distributions as interactive charts, helping users better understand their portfolio.
